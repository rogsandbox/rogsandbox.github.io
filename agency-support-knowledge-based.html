<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Agency Support | Knowledge-Based</title>
		<link rel="stylesheet" href="styles/aoskb.css" />
	</head>
	<body>
		<div id="app">
			<section class="search-form">
				<form onsubmit="return false;">
					<div class="search__wrapper">
						<input
							type="text"
							name="search"
							autocomplete="off"
							placeholder="Search: Articles, FAQs, Tutorials"
						/>
						<button type="button" class="clear-search">X</button>
					</div>
				</form>
			</section>
			<section class="article">
				<ul class="article__section_list"></ul>
			</section>
		</div>

		<script defer>
			document.addEventListener("DOMContentLoaded", async (e) => {
				// const FILE_PATH = "./data/data.json";
				// const { data: articles } = await getArticles(FILE_PATH);
				const articles = await getArticles();
				// console.log("articles", articles);

				const input = document.querySelector(
					'.search__wrapper > input[type="text"]'
				);
				const clearSearch = document.querySelector(".clear-search");
				const iframeContainer = document.querySelector(".iframe-container");
				const articleList = document.querySelector(".article__section_list");

				const handleKeydown = debounce((e) => {
					const el = e.target;
					const search = el.value.trim().toLowerCase();

					if (!search) {
						clearSearch.classList.remove("active");
						return;
					}

					clearSearch.classList.add("active");

					const filteredArticles = articles.filter((article, index) => {
						const title = article[0]?.toLowerCase();

						if (index <= 0 || !title) {
							return false;
						}

						return title.includes(search);
					});

					// console.log("filteredArticles", filteredArticles);

					// remove all list
					removeNodes(articleList.childNodes);

					if (filteredArticles.length <= 0) {
						const list = document.createElement("li");
						list.textContent = "No article found";
						articleList.insertAdjacentElement("afterbegin", list);
						return;
					}

					filteredArticles.forEach((fa) => {
						const title = fa[0] ?? "";
						const descriptions = (fa[1] ?? "")
							.split("|")
							.map((desc) => desc.trim());
						const iframeSrc = fa[2];

						console.log("filters", { title, descriptions, iframeSrc });

						const list = document.createElement("li");
						const ul = document.createElement("ul");
						list.classList.add("article__section_list_item");
						list.textContent = title;

						descriptions.forEach((desc) => {
							const li = document.createElement("li");
							li.textContent = desc;
							ul.appendChild(li);
						});

						list.appendChild(ul);

						if (iframeSrc) {
							const btn = document.createElement("button");
							btn.classList.add("view-iframe-btn");
							btn.textContent = "View Document";
							btn.dataset.iframeSrc = iframeSrc;
							btn.onclick = viewDocument;
							list.appendChild(btn);
						}

						articleList.insertAdjacentElement("afterbegin", list);
					});
				});

				input.addEventListener("keydown", handleKeydown);

				clearSearch.addEventListener("click", function (e) {
					this.classList.remove("active");
					input.value = "";
					input.focus();
				});

				function viewDocument(_e) {
					const root = this.parentNode;
					const iframeContainer = root.querySelector("iframe-wrapper");

					document.body.style.overflow = "hidden";

					if (!iframeContainer) {
						const wrapper = document.createElement("div");
						const closeBtn = document.createElement("button");
						const iframe = document.createElement("iframe");

						iframe.src = this.dataset["iframeSrc"];
						iframe.setAttribute("webkitallowfullscreen", true);
						iframe.setAttribute("mozallowfullscreen", true);
						iframe.setAttribute("allowfullscreen", true);

						closeBtn.classList.add("close-iframe");
						closeBtn.textContent = "X";
						closeBtn.onclick = handleCloseIframe;
						wrapper.classList.add("iframe-wrapper", "active");

						wrapper.appendChild(closeBtn);
						wrapper.appendChild(iframe);
						root.appendChild(wrapper);

						wrapper.addEventListener("animationend", handleShowAnimation, {
							once: true,
						});

						return;
					}

					iframeContainer.classList.add("active");
					iframeContainer.addEventListener(
						"animationend",
						handleShowAnimation,
						{ once: true }
					);
				}

				function handleShowAnimation(_e) {
					this.removeEventListener("animationend", handleShowAnimation);
					document.body.style.overflow = "";
				}

				function handleCloseIframe() {
					const parent = this.parentNode;

					parent.classList.add("closing");
					document.body.style.overflow = "hidden";

					parent.addEventListener(
						"animationend",
						function handleClose(_e) {
							this.classList.remove("closing");
							parent.classList.remove("active");
							document.body.style.overflow = "";
							this.removeEventListener("animationend", handleClose);
						},
						{ once: true }
					);
				}

				function debounce(closure, timeout = 500) {
					let timer;

					return function (...args) {
						clearTimeout(timer);

						timer = setTimeout(() => {
							return closure.apply(this, args);
						}, timeout);
					};
				}

				// async function getArticles(file) {
				// 	const res = await fetch(FILE_PATH);

				// 	return await res.json();
				// }

				function removeNodes(nodes) {
					while (nodes.length !== 0) {
						const child = nodes[0];
						child.parentNode.removeChild(child);
					}
				}

				async function getArticles() {
					const sheetId = "11aPDLBt1YQtzGdvJNZ9AQneRewEUlNKxAR56mllWDt0";
					const apiKey = "AIzaSyARq4dazEOfonecrYd85jexLVuaI2QqRZo";
					const sheetName = "Knowledge base";
					const range = "A1:C";
					const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${sheetName}!${range}?key=${apiKey}`;

					try {
						const res = await fetch(url);
						const data = await res.json();

						return data.values;
					} catch (err) {
						console.error("Error fetching sheet:", err);
						return [];
					}
				}
			});
		</script>
	</body>
</html>
